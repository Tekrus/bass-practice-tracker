{% extends "base.html" %}

{% block title %}Timing Practice - Bass Practice{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/timing_practice.css') }}">
{% endblock %}

{% block content %}
<div class="container py-4">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1><i class="bi bi-stopwatch"></i> Timing Practice</h1>
            <p class="text-secondary mb-0">Practice tight timing with your bass using audio input</p>
        </div>
        <div class="d-flex align-items-center gap-3">
            <div class="d-flex align-items-center gap-2">
                <span class="text-secondary">Audio:</span>
                <div class="audio-indicator" id="audio-status"></div>
                <span id="audio-status-text" class="text-muted small">Not connected</span>
            </div>
            <button class="btn btn-outline-primary" id="connect-audio-btn">
                <i class="bi bi-mic"></i> Connect Audio
            </button>
        </div>
    </div>

    <!-- Audio Setup Panel -->
    <div class="card mb-4" id="audio-setup-panel" style="display: none;">
        <div class="card-body">
            <h5 class="card-title"><i class="bi bi-sliders"></i> Audio Input Setup</h5>
            <div class="row align-items-center">
                <div class="col-md-4">
                    <label class="form-label">Select Audio Input</label>
                    <select class="form-select" id="audio-device-select">
                        <option value="">Loading devices...</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Input Level</label>
                    <div class="volume-meter">
                        <div class="volume-meter-fill" id="volume-meter-fill"></div>
                    </div>
                    <small class="text-muted">Threshold: <span id="threshold-value">Auto</span></small>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Audio Latency</label>
                    <span id="calibration-offset-display" class="badge bg-secondary">50ms</span>
                </div>
                <div class="col-md-2">
                    <label class="form-label">&nbsp;</label>
                    <button class="btn btn-outline-warning w-100" id="calibrate-btn">
                        <i class="bi bi-bullseye"></i> Calibrate
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Game Selection -->
    <div id="game-selection">
        <h3 class="mb-3">Choose Your Game</h3>
        <div class="row g-4 mb-4">
            {% for mode_id, mode in game_modes.items() %}
            <div class="col-md-4">
                <div class="card game-card h-100" data-mode="{{ mode_id }}">
                    <div class="card-body text-center">
                        <div class="game-icon" style="color: {{ mode.color }};">
                            <i class="bi bi-{{ mode.icon }}"></i>
                        </div>
                        <h4 class="card-title">{{ mode.name }}</h4>
                        <p class="card-text">{{ mode.description }}</p>
                        {% if high_scores.get(mode_id) %}
                        <div class="mt-3">
                            <span class="badge bg-warning text-dark">
                                <i class="bi bi-trophy"></i> High Score: {{ high_scores[mode_id].high_score }}
                            </span>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>

        <!-- Game Settings -->
        <div class="card mb-4">
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-md-4">
                        <label class="form-label">Difficulty</label>
                        <div class="btn-group d-flex" role="group">
                            {% for level, config in difficulty_levels.items() %}
                            <button type="button"
                                class="difficulty-btn flex-fill {% if level == 1 %}selected{% endif %}"
                                data-difficulty="{{ level }}">
                                {{ config.name }}
                            </button>
                            {% endfor %}
                        </div>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Tempo (BPM)</label>
                        <div class="input-group">
                            <input type="number" class="form-control" id="tempo-input" min="40" max="200" value="80">
                            <button class="btn btn-outline-secondary" type="button" id="random-tempo-btn"
                                title="Random tempo">
                                <i class="bi bi-shuffle"></i>
                            </button>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Duration (bars)</label>
                        <select class="form-select" id="duration-select">
                            <option value="4">4 bars</option>
                            <option value="8" selected>8 bars</option>
                            <option value="16">16 bars</option>
                            <option value="32">32 bars (endurance)</option>
                        </select>
                    </div>
                    <div class="col-md-2 d-flex align-items-end">
                        <button class="btn btn-primary btn-lg w-100" id="start-game-btn" disabled>
                            <i class="bi bi-play-fill"></i> Start
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Stats Overview -->
        <div class="row g-4">
            <div class="col-md-3">
                <div class="card stat-card">
                    <div class="stat-value">{{ total_sessions }}</div>
                    <div class="stat-label">Total Sessions</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stat-card">
                    <div class="stat-value">{{ total_notes }}</div>
                    <div class="stat-label">Notes Played</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stat-card">
                    <div class="stat-value">{{ overall_accuracy }}%</div>
                    <div class="stat-label">Overall Accuracy</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stat-card">
                    <div class="stat-value">{% if best_session %}{{ best_session.score }}{% else %}0{% endif %}</div>
                    <div class="stat-label">Best Score</div>
                </div>
            </div>
        </div>

        <!-- Recent Sessions -->
        {% if recent_sessions %}
        <div class="card mt-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-clock-history"></i> Recent Sessions</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-dark table-hover mb-0">
                        <thead>
                            <tr>
                                <th>Game</th>
                                <th>Tempo</th>
                                <th>Difficulty</th>
                                <th>Score</th>
                                <th>Accuracy</th>
                                <th>Perfect</th>
                                <th>Date</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for session in recent_sessions %}
                            <tr>
                                <td>{{ game_modes[session.game_mode].name if session.game_mode in game_modes else
                                    session.game_mode }}</td>
                                <td>{{ session.tempo_bpm }} BPM</td>
                                <td>{{ difficulty_levels[session.difficulty].name if session.difficulty in
                                    difficulty_levels else session.difficulty }}</td>
                                <td><strong>{{ session.score }}</strong></td>
                                <td>{{ session.accuracy_percentage }}%</td>
                                <td>{{ session.perfect_percentage }}%</td>
                                <td>{{ session.created_at.strftime('%b %d, %H:%M') }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Game Container (Hidden until game starts) -->
    <div id="game-container">
        <!-- Countdown -->
        <div id="countdown-screen" class="text-center py-5" style="display: none;">
            <p class="text-secondary mb-3">
                <span id="countdown-tempo">80</span> BPM
                <span id="countdown-calibration" class="ms-3 badge bg-secondary">0ms offset</span>
            </p>
            <div class="countdown" id="countdown-number">4</div>
            <p class="text-muted mt-3">Listen for the clicks - game starts after the count-in!</p>
        </div>

        <!-- Game UI -->
        <div id="game-screen" style="display: none;">
            <div class="row mb-4">
                <div class="col-md-4 text-center">
                    <div class="score-display" id="current-score">0</div>
                    <div class="text-secondary">Score</div>
                </div>
                <div class="col-md-4 text-center">
                    <div class="hit-feedback" id="hit-feedback">&nbsp;</div>
                    <div id="timing-offset" class="text-muted"></div>
                </div>
                <div class="col-md-4 text-center">
                    <div class="streak-display" id="streak-display">
                        <i class="bi bi-fire"></i> <span id="current-streak">0</span>
                    </div>
                    <div class="text-secondary">Streak</div>
                </div>
            </div>

            <!-- Beat Track -->
            <div class="beat-track" id="beat-track">
                <div class="beat-line"></div>
                <!-- Notes will be added dynamically -->
            </div>

            <!-- Progress -->
            <div class="d-flex justify-content-between align-items-center mb-3">
                <span class="text-secondary">
                    <i class="bi bi-music-note"></i> <span id="notes-hit">0</span> / <span id="total-notes">0</span>
                    notes
                </span>
                <span class="text-secondary">
                    <i class="bi bi-speedometer2"></i> <span id="current-tempo">80</span> BPM
                </span>
                <span class="text-secondary">
                    <i class="bi bi-clock"></i> <span id="time-remaining">0:00</span>
                </span>
            </div>

            <div class="progress mb-4" style="height: 8px;">
                <div class="progress-bar bg-primary" id="game-progress" style="width: 0%"></div>
            </div>

            <!-- Controls -->
            <div class="text-center">
                <button class="btn btn-outline-danger btn-lg" id="stop-game-btn">
                    <i class="bi bi-stop-fill"></i> Stop Game
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Calibration Modal -->
<div class="modal fade" id="calibration-modal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-bullseye"></i> Audio Setup</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" id="calibration-close-btn"></button>
            </div>
            <div class="modal-body">

                <!-- Step 1: Threshold Calibration -->
                <div id="calibration-step-threshold" class="calibration-step text-center">
                    <h5 class="mb-4">Set Input Threshold</h5>

                    <!-- Sub-step 1a: Ambient noise -->
                    <div id="threshold-ambient">
                        <p class="text-secondary mb-3">Sampling ambient noise...</p>
                        <div class="alert alert-info">
                            <i class="bi bi-volume-mute"></i> <strong>Stay quiet</strong> for a moment
                        </div>
                        <div class="progress my-4" style="height: 8px;">
                            <div class="progress-bar progress-bar-striped progress-bar-animated bg-info"
                                id="ambient-progress" style="width: 0%"></div>
                        </div>
                    </div>

                    <!-- Sub-step 1b: Signal confirmation -->
                    <div id="threshold-confirm" style="display: none;">
                        <p class="text-secondary mb-3">Now confirm your input</p>
                        <div class="alert alert-success">
                            <i class="bi bi-music-note"></i> <strong>Play a few notes</strong> on your bass
                        </div>
                        <div class="my-4">
                            <div class="audio-indicator large mx-auto" id="threshold-indicator"></div>
                        </div>
                        <p id="threshold-status" class="text-muted">Waiting for signal...</p>
                        <div class="calibration-dots-container mt-3" id="threshold-dots">
                            <div class="calibration-dot" id="thresh-dot-0"></div>
                            <div class="calibration-dot" id="thresh-dot-1"></div>
                            <div class="calibration-dot" id="thresh-dot-2"></div>
                        </div>
                    </div>
                </div>

                <!-- Results -->
                <div id="calibration-step-results" class="calibration-step text-center" style="display: none;">
                    <h5 class="mb-4"><i class="bi bi-check-circle text-success"></i> Setup Complete!</h5>

                    <div class="row mb-4">
                        <div class="col-6">
                            <div class="card">
                                <div class="card-body py-3">
                                    <div class="h3 mb-0" id="result-threshold">30</div>
                                    <small class="text-muted">Input Threshold</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="card">
                                <div class="card-body py-3">
                                    <div class="h3 mb-0" id="result-latency">50ms</div>
                                    <small class="text-muted">Latency (est.)</small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <p class="text-muted mb-4">
                        <i class="bi bi-info-circle"></i>
                        Settings saved automatically.
                    </p>

                    <div class="d-flex gap-2 justify-content-center">
                        <button class="btn btn-outline-secondary" id="recalibrate-btn">
                            <i class="bi bi-arrow-repeat"></i> Redo
                        </button>
                        <button class="btn btn-primary" id="apply-calibration-btn">
                            <i class="bi bi-check-lg"></i> Done
                        </button>
                    </div>
                </div>

            </div>
        </div>
    </div>
</div>

<!-- Results Modal -->
<div class="modal fade" id="results-modal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-trophy"></i> Game Complete!</h5>
            </div>
            <div class="modal-body">
                <div id="new-high-score-banner" class="alert alert-warning text-center mb-4" style="display: none;">
                    <i class="bi bi-star-fill"></i> NEW HIGH SCORE! <i class="bi bi-star-fill"></i>
                </div>

                <div class="row mb-4">
                    <div class="col-md-4">
                        <div class="result-stat">
                            <div class="value" id="result-score">0</div>
                            <div class="label">Final Score</div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="result-stat">
                            <div class="value" id="result-accuracy">0%</div>
                            <div class="label">Accuracy</div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="result-stat">
                            <div class="value" id="result-streak">0</div>
                            <div class="label">Best Streak</div>
                        </div>
                    </div>
                </div>

                <h6 class="mb-2">Hit Breakdown</h6>
                <div class="timing-bar mb-3" id="timing-breakdown">
                    <!-- Filled dynamically -->
                </div>
                <div class="d-flex justify-content-between text-muted small mb-4">
                    <span><span class="badge" style="background:#22c55e">Perfect</span> <span
                            id="result-perfect">0</span></span>
                    <span><span class="badge" style="background:#3b82f6">Good</span> <span
                            id="result-good">0</span></span>
                    <span><span class="badge" style="background:#06b6d4">Ok</span> <span id="result-ok">0</span></span>
                    <span><span class="badge" style="background:#f59e0b;color:#000">Early</span> <span
                            id="result-early">0</span></span>
                    <span><span class="badge" style="background:#fb923c;color:#000">Late</span> <span
                            id="result-late">0</span></span>
                    <span><span class="badge bg-danger">Miss</span> <span id="result-miss">0</span></span>
                </div>

                <h6 class="mb-2">Tips</h6>
                <ul class="list-unstyled" id="result-tips">
                    <!-- Filled dynamically -->
                </ul>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Back to Menu</button>
                <button type="button" class="btn btn-primary" id="play-again-btn">
                    <i class="bi bi-arrow-repeat"></i> Play Again
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/timing_practice.js') }}"></script>
{% endblock %}