{% extends "base.html" %}
{% from "macros/badges.html" import star_rating %}

{% block title %}Songs - Bass Practice{% endblock %}

{% block content %}
<div class="container-fluid px-4">
    <div class="row mb-4">
        <div class="col-12 d-flex justify-content-between align-items-center">
            <div>
                <h1><i class="bi bi-music-note-list"></i> Song Library</h1>
                <p class="text-secondary">Track and manage your song practice</p>
            </div>
            <div class="btn-group">
                <button id="suggest-song-btn" class="btn btn-success">
                    <i class="bi bi-lightbulb"></i> Get AI Suggestion
                </button>
                <a href="{{ url_for('songs.add_song') }}" class="btn btn-primary">
                    <i class="bi bi-plus-lg"></i> Add Song
                </a>
            </div>
        </div>
    </div>

    <!-- Song Suggestion Card (hidden by default) -->
    <div id="suggestion-container" class="row mb-4" style="display: none;">
        <div class="col-12">
            <div class="card border-success">
                <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                    <span><i class="bi bi-lightbulb-fill"></i> AI Song Suggestion</span>
                    <button type="button" class="btn-close btn-close-white" onclick="hideSuggestion()"></button>
                </div>
                <div class="card-body">
                    <!-- Provider/Model Selection -->
                    <div id="suggestion-config" class="row mb-3">
                        <div class="col-md-4">
                            <label class="form-label small text-secondary">AI Provider</label>
                            <select id="provider-select" class="form-select form-select-sm">
                                <option value="">Loading providers...</option>
                            </select>
                        </div>
                        <div class="col-md-5">
                            <label class="form-label small text-secondary">Model</label>
                            <select id="model-select" class="form-select form-select-sm">
                                <option value="">Select a provider first</option>
                            </select>
                        </div>
                        <div class="col-md-3 d-flex align-items-end">
                            <button id="generate-btn" class="btn btn-success btn-sm w-100">
                                <i class="bi bi-magic"></i> Generate
                            </button>
                        </div>
                    </div>

                    <!-- Song Generation Options -->
                    <div class="row mb-3">
                        <div class="col-md-3">
                            <label class="form-label small text-secondary">Difficulty Level</label>
                            <select id="level-select" class="form-select form-select-sm">
                                <option value="">Any level</option>
                                <option value="1">1 - Absolute Beginner</option>
                                <option value="2">2 - Beginner</option>
                                <option value="3">3 - Intermediate</option>
                                <option value="4">4 - Advanced</option>
                                <option value="5">5 - Expert</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label small text-secondary">Genre</label>
                            <select id="genre-select" class="form-select form-select-sm">
                                <option value="">Any genre</option>
                                <option value="rock">Rock</option>
                                <option value="blues">Blues</option>
                                <option value="jazz">Jazz</option>
                                <option value="funk">Funk</option>
                                <option value="soul">Soul</option>
                                <option value="r&b">R&B</option>
                                <option value="metal">Metal</option>
                                <option value="punk">Punk</option>
                                <option value="pop">Pop</option>
                                <option value="reggae">Reggae</option>
                                <option value="country">Country</option>
                                <option value="disco">Disco</option>
                                <option value="hip-hop">Hip-Hop</option>
                                <option value="progressive">Progressive</option>
                                <option value="fusion">Fusion</option>
                                <option value="motown">Motown</option>
                                <option value="other">Other (specify below)</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label small text-secondary">Custom Genre (if "Other" selected)</label>
                            <input type="text" id="custom-genre" class="form-control form-control-sm"
                                placeholder="e.g., Afrobeat, Ska, Latin Jazz..." disabled>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-12">
                            <label class="form-label small text-secondary">Custom Instructions (optional)</label>
                            <textarea id="custom-instructions" class="form-control form-control-sm" rows="2"
                                placeholder="e.g., Key of E minor, slap bass technique, groovy feeling, minor pentatonic scale, walking bass line..."></textarea>
                            <small class="text-muted">Specify key, scale, technique, feeling, or any other
                                preferences</small>
                        </div>
                    </div>
                    <div id="api-key-warning" class="alert alert-info small py-2" style="display: none;">
                        <i class="bi bi-info-circle"></i> <span id="api-key-warning-text"></span>
                    </div>

                    <div id="suggestion-loading" class="text-center py-4" style="display: none;">
                        <div class="spinner-border text-success" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2 text-secondary">Analyzing your library and skills...</p>
                    </div>
                    <div id="suggestion-content" style="display: none;">
                        <div class="row">
                            <div class="col-md-8">
                                <h4 id="suggestion-title" class="mb-1"></h4>
                                <h6 id="suggestion-artist" class="text-secondary mb-3"></h6>
                                <div class="d-flex flex-wrap gap-2 mb-3">
                                    <span id="suggestion-genre" class="badge bg-info"></span>
                                    <span id="suggestion-difficulty" class="badge bg-secondary"></span>
                                    <span id="suggestion-key" class="badge bg-secondary"></span>
                                    <span id="suggestion-tempo" class="badge bg-secondary"></span>
                                </div>
                                <div class="alert alert-info">
                                    <strong><i class="bi bi-chat-quote"></i> Why this song?</strong>
                                    <p id="suggestion-reason" class="mb-0 mt-2"></p>
                                </div>
                            </div>
                            <div class="col-md-4 d-flex flex-column justify-content-center">
                                <button id="add-suggestion-btn" class="btn btn-success btn-lg mb-2">
                                    <i class="bi bi-plus-lg"></i> Add to Library
                                </button>
                                <button id="another-btn" class="btn btn-outline-secondary">
                                    <i class="bi bi-arrow-repeat"></i> Get Another
                                </button>
                            </div>
                        </div>
                    </div>
                    <div id="suggestion-error" style="display: none;">
                        <div class="alert alert-warning mb-0">
                            <i class="bi bi-exclamation-triangle"></i>
                            <span id="suggestion-error-text"></span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Today's Playlist -->
    {% if playlist %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="card bg-gradient"
                style="background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);">
                <div class="card-body">
                    <h4 class="text-white mb-3"><i class="bi bi-calendar-check"></i> Today's Playlist</h4>
                    <div class="row">
                        {% for song in playlist %}
                        <div class="col-md-4 col-lg-2 mb-3">
                            <div class="card bg-dark">
                                <div class="card-body py-2 px-3">
                                    <strong>{{ song.title }}</strong>
                                    {% if song.artist %}
                                    <br><small class="text-secondary">{{ song.artist }}</small>
                                    {% endif %}
                                    {{ star_rating(song.mastery_level, extra_class='mt-1', extra_style='font-size:
                                    0.8rem;') }}
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Filters -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <form method="GET" class="row g-3">
                        <div class="col-md-3">
                            <label class="form-label">Genre</label>
                            <select name="genre" class="form-select" onchange="this.form.submit()">
                                <option value="">All Genres</option>
                                {% for g in genres %}
                                <option value="{{ g }}" {% if g==current_genre %}selected{% endif %}>
                                    {{ g|capitalize }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Mastery Level</label>
                            <select name="mastery" class="form-select" onchange="this.form.submit()">
                                <option value="">All Levels</option>
                                {% for i in range(6) %}
                                <option value="{{ i }}" {% if i==current_mastery %}selected{% endif %}>
                                    {{ 'â˜…' * i if i > 0 else 'New' }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Search</label>
                            <input type="text" name="search" class="form-control" placeholder="Search songs..."
                                value="{{ search }}">
                        </div>
                        <div class="col-md-2 d-flex align-items-end">
                            <button type="submit" class="btn btn-primary w-100">
                                <i class="bi bi-search"></i> Search
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Song List -->
    <div class="row">
        {% for song in songs %}
        <div class="col-lg-4 col-md-6 mb-4">
            <div class="card exercise-card h-100">
                <div class="card-header d-flex justify-content-between align-items-center">
                    {% if song.genre %}
                    <span class="badge bg-info">{{ song.genre|capitalize }}</span>
                    {% else %}
                    <span class="badge bg-secondary">No genre</span>
                    {% endif %}
                    {{ star_rating(song.mastery_level) }}
                </div>
                <div class="card-body">
                    <h5 class="card-title">{{ song.title }}</h5>
                    {% if song.artist %}
                    <h6 class="card-subtitle text-secondary mb-3">{{ song.artist }}</h6>
                    {% endif %}

                    <div class="d-flex flex-wrap gap-2 mb-3">
                        {% if song.difficulty_level %}
                        <span class="badge bg-secondary">
                            <i class="bi bi-bar-chart"></i> Level {{ song.difficulty_level }}
                        </span>
                        {% endif %}
                        {% if song.tempo_bpm %}
                        <span class="badge bg-secondary">
                            <i class="bi bi-speedometer2"></i> {{ song.tempo_bpm }} BPM
                        </span>
                        {% endif %}
                        {% if song.key_signature %}
                        <span class="badge bg-secondary">
                            <i class="bi bi-music-note"></i> {{ song.key_signature }}
                        </span>
                        {% endif %}
                    </div>

                    <p class="card-text text-secondary small">
                        <i class="bi bi-arrow-repeat"></i> Practiced {{ song.practice_count }} times
                        {% if song.last_practiced %}
                        <br><i class="bi bi-calendar"></i> Last: {{ song.last_practiced.strftime('%b %d') }}
                        {% endif %}
                    </p>
                </div>
                <div class="card-footer bg-transparent d-flex justify-content-between">
                    <div class="btn-group btn-group-sm">
                        <button class="btn btn-success practice-song-btn" data-song-id="{{ song.id }}" data-quality="4">
                            <i class="bi bi-hand-thumbs-up"></i>
                        </button>
                        <button class="btn btn-warning practice-song-btn" data-song-id="{{ song.id }}" data-quality="3">
                            <i class="bi bi-dash-circle"></i>
                        </button>
                        <button class="btn btn-danger practice-song-btn" data-song-id="{{ song.id }}" data-quality="2">
                            <i class="bi bi-hand-thumbs-down"></i>
                        </button>
                    </div>
                    <div class="btn-group btn-group-sm">
                        {% if song.youtube_url %}
                        <a href="{{ song.youtube_url }}" target="_blank" class="btn btn-outline-danger">
                            <i class="bi bi-youtube"></i>
                        </a>
                        {% endif %}
                        <a href="{{ url_for('songs.edit_song', song_id=song.id) }}" class="btn btn-outline-primary">
                            <i class="bi bi-pencil"></i>
                        </a>
                    </div>
                </div>
            </div>
        </div>
        {% else %}
        <div class="col-12">
            <div class="text-center py-5">
                <i class="bi bi-music-note-beamed display-1 text-secondary"></i>
                <h4 class="mt-3">No songs in your library</h4>
                <p class="text-secondary">Add songs you want to practice</p>
                <a href="{{ url_for('songs.add_song') }}" class="btn btn-primary">
                    <i class="bi bi-plus-lg"></i> Add Your First Song
                </a>
            </div>
        </div>
        {% endfor %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/songs.js') }}"></script>
{% endblock %}