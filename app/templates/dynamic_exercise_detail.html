{% extends "base.html" %}

{% block title %}{{ exercise.title }} - Bass Practice{% endblock %}

{% block content %}
<div class="container-fluid px-4">
    <nav aria-label="breadcrumb" class="mb-4">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{{ url_for('main.dashboard') }}">Dashboard</a></li>
            <li class="breadcrumb-item"><a href="{{ url_for('main.exercises') }}">Exercises</a></li>
            <li class="breadcrumb-item active">{{ exercise.title }}</li>
        </ol>
    </nav>
    
    <div class="row">
        <div class="col-lg-8">
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h4 class="mb-0">{{ exercise.title }}</h4>
                    <div>
                        <span class="badge bg-primary text-capitalize">{{ exercise.category }}</span>
                        <span class="badge bg-secondary">Level {{ exercise.difficulty_level }}</span>
                    </div>
                </div>
                <div class="card-body">
                    <p class="lead">{{ exercise.description }}</p>
                    
                    {% if exercise.key_signature or exercise.tempo_bpm %}
                    <div class="row mb-4">
                        {% if exercise.key_signature %}
                        <div class="col-auto">
                            <span class="text-secondary">Key:</span>
                            <strong>{{ exercise.key_signature }}</strong>
                        </div>
                        {% endif %}
                        {% if exercise.tempo_bpm %}
                        <div class="col-auto">
                            <span class="text-secondary">Tempo:</span>
                            <strong>{{ exercise.tempo_bpm }} BPM</strong>
                        </div>
                        {% endif %}
                        <div class="col-auto">
                            <span class="text-secondary">Duration:</span>
                            <strong>{{ exercise.estimated_duration }} min</strong>
                        </div>
                    </div>
                    {% endif %}
                    
                    <h5><i class="bi bi-list-check"></i> Instructions</h5>
                    <div class="bg-dark p-3 rounded mb-4">
                        <pre class="mb-0 text-light" style="white-space: pre-wrap;">{{ exercise.instructions }}</pre>
                    </div>
                    
                    {% if exercise.tab_notation %}
                    <h5><i class="bi bi-music-note-list"></i> Tab</h5>
                    <div class="bg-dark p-3 rounded mb-4">
                        <pre class="mb-0 text-light" style="font-family: monospace;">{{ exercise.tab_notation }}</pre>
                    </div>
                    {% endif %}
                    
                    {% if exercise.tips %}
                    <h5><i class="bi bi-lightbulb"></i> Tips</h5>
                    <div class="alert alert-info">
                        {{ exercise.tips }}
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <div class="col-lg-4">
            <!-- Metronome / Drum Track Toggle -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-stopwatch"></i> Timing</h5>
                </div>
                <div class="card-body">
                    <!-- Mode Toggle -->
                    <div class="btn-group w-100 mb-3" role="group">
                        <input type="radio" class="btn-check" name="timingMode" id="modeMetronome" checked>
                        <label class="btn btn-outline-primary" for="modeMetronome">
                            <i class="bi bi-stopwatch"></i> Metronome
                        </label>
                        <input type="radio" class="btn-check" name="timingMode" id="modeDrums">
                        <label class="btn btn-outline-primary" for="modeDrums">
                            <i class="bi bi-music-note-beamed"></i> Drum Beat
                        </label>
                    </div>
                    
                    <!-- BPM Display & Control -->
                    <div class="text-center">
                        <div class="metronome-bpm mb-3" id="bpmDisplay">{{ exercise.tempo_bpm or 80 }}</div>
                        <div class="mb-3">
                            <input type="range" class="form-range" id="tempoSlider" 
                                   min="40" max="200" value="{{ exercise.tempo_bpm or 80 }}">
                        </div>
                    </div>
                    
                    <!-- Drum Pattern Selector (hidden by default) -->
                    <div id="drumPatternSection" class="mb-3" style="display: none;">
                        <label class="form-label">Drum Pattern</label>
                        <select class="form-select" id="drumPatternSelect">
                            <option value="basic_rock">Basic Rock</option>
                            <option value="funk">Funk</option>
                            <option value="blues_shuffle">Blues Shuffle</option>
                            <option value="jazz_swing">Jazz Swing</option>
                            <option value="latin">Latin</option>
                            <option value="reggae">Reggae</option>
                            <option value="disco">Disco</option>
                            <option value="metal">Metal</option>
                        </select>
                        <div class="form-text">Select a pattern that fits the exercise style</div>
                    </div>
                    
                    <!-- Play Controls -->
                    <div class="text-center">
                        <div class="btn-group">
                            <button class="btn btn-outline-secondary" onclick="adjustTempo(-5)">-5</button>
                            <button class="btn btn-primary" id="metronomeBtn" onclick="toggleTiming()">
                                <i class="bi bi-play-fill"></i> Start
                            </button>
                            <button class="btn btn-outline-secondary" onclick="adjustTempo(5)">+5</button>
                        </div>
                    </div>
                    
                    <!-- Volume Control -->
                    <div class="mt-3">
                        <label class="form-label small"><i class="bi bi-volume-up"></i> Volume</label>
                        <input type="range" class="form-range" id="volumeSlider" min="0" max="100" value="70">
                    </div>
                </div>
            </div>
            
            <!-- Timer -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-clock"></i> Timer</h5>
                </div>
                <div class="card-body text-center">
                    <div class="display-4 mb-3" id="timerDisplay">{{ exercise.estimated_duration }}:00</div>
                    <div class="btn-group">
                        <button class="btn btn-success" onclick="startTimer()">
                            <i class="bi bi-play-fill"></i>
                        </button>
                        <button class="btn btn-warning" onclick="pauseTimer()">
                            <i class="bi bi-pause-fill"></i>
                        </button>
                        <button class="btn btn-danger" onclick="resetTimer()">
                            <i class="bi bi-stop-fill"></i>
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Mark Complete -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-check-circle"></i> Track Progress</h5>
                </div>
                <div class="card-body">
                    <p class="text-secondary small">Mark this exercise as complete to update your skill progress</p>
                    <button class="btn btn-success w-100" id="completeExerciseBtn" onclick="markExerciseComplete()">
                        <i class="bi bi-check-circle"></i> Mark as Complete
                    </button>
                    <div id="completeStatus" class="mt-2"></div>
                </div>
            </div>
            
            <!-- Generate New -->
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-arrow-repeat"></i> Generate New</h5>
                </div>
                <div class="card-body">
                    <p class="text-secondary small">Generate a new exercise in the same category</p>
                    <a href="{{ url_for('main.exercises') }}?generate=1&category={{ exercise.category }}&difficulty={{ exercise.difficulty_level }}" 
                       class="btn btn-outline-primary w-100">
                        <i class="bi bi-shuffle"></i> New {{ exercise.category|title }} Exercise
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Timer
    let timerSeconds = {{ exercise.estimated_duration }} * 60;
    let timerInterval = null;
    let timerRunning = false;
    
    function updateTimerDisplay() {
        const minutes = Math.floor(timerSeconds / 60);
        const seconds = timerSeconds % 60;
        document.getElementById('timerDisplay').textContent = 
            `${minutes}:${seconds.toString().padStart(2, '0')}`;
    }
    
    function startTimer() {
        if (!timerRunning && timerSeconds > 0) {
            timerRunning = true;
            timerInterval = setInterval(() => {
                timerSeconds--;
                updateTimerDisplay();
                if (timerSeconds <= 0) {
                    pauseTimer();
                    alert('Time is up!');
                }
            }, 1000);
        }
    }
    
    function pauseTimer() {
        timerRunning = false;
        if (timerInterval) {
            clearInterval(timerInterval);
            timerInterval = null;
        }
    }
    
    function resetTimer() {
        pauseTimer();
        timerSeconds = {{ exercise.estimated_duration }} * 60;
        updateTimerDisplay();
    }
    
    // Audio Context
    let audioContext = null;
    let timingRunning = false;
    let timingInterval = null;
    let drumScheduler = null;
    let currentBeat = 0;
    let volume = 0.7;
    
    function initAudioContext() {
        if (!audioContext) {
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
        }
        if (audioContext.state === 'suspended') {
            audioContext.resume();
        }
        return audioContext;
    }
    
    // Get current mode (metronome or drums)
    function isDrumMode() {
        return document.getElementById('modeDrums').checked;
    }
    
    // Metronome click sound
    function playClick(accent = false) {
        const ctx = initAudioContext();
        const oscillator = ctx.createOscillator();
        const gainNode = ctx.createGain();
        
        oscillator.connect(gainNode);
        gainNode.connect(ctx.destination);
        
        oscillator.frequency.value = accent ? 1200 : 1000;
        oscillator.type = 'square';
        
        const vol = accent ? 0.4 * volume : 0.3 * volume;
        gainNode.gain.setValueAtTime(vol, ctx.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.05);
        
        oscillator.start(ctx.currentTime);
        oscillator.stop(ctx.currentTime + 0.05);
    }
    
    // Drum synthesis functions
    function playKick(time) {
        const ctx = initAudioContext();
        const osc = ctx.createOscillator();
        const gain = ctx.createGain();
        
        osc.connect(gain);
        gain.connect(ctx.destination);
        
        osc.frequency.setValueAtTime(150, time);
        osc.frequency.exponentialRampToValueAtTime(40, time + 0.1);
        
        gain.gain.setValueAtTime(0.8 * volume, time);
        gain.gain.exponentialRampToValueAtTime(0.01, time + 0.3);
        
        osc.start(time);
        osc.stop(time + 0.3);
    }
    
    function playSnare(time) {
        const ctx = initAudioContext();
        
        // Noise for snare
        const noiseBuffer = ctx.createBuffer(1, ctx.sampleRate * 0.2, ctx.sampleRate);
        const noiseData = noiseBuffer.getChannelData(0);
        for (let i = 0; i < noiseBuffer.length; i++) {
            noiseData[i] = Math.random() * 2 - 1;
        }
        
        const noise = ctx.createBufferSource();
        noise.buffer = noiseBuffer;
        
        const noiseFilter = ctx.createBiquadFilter();
        noiseFilter.type = 'highpass';
        noiseFilter.frequency.value = 1000;
        
        const noiseGain = ctx.createGain();
        noiseGain.gain.setValueAtTime(0.5 * volume, time);
        noiseGain.gain.exponentialRampToValueAtTime(0.01, time + 0.15);
        
        noise.connect(noiseFilter);
        noiseFilter.connect(noiseGain);
        noiseGain.connect(ctx.destination);
        
        // Body tone
        const osc = ctx.createOscillator();
        const oscGain = ctx.createGain();
        osc.connect(oscGain);
        oscGain.connect(ctx.destination);
        
        osc.frequency.value = 200;
        oscGain.gain.setValueAtTime(0.4 * volume, time);
        oscGain.gain.exponentialRampToValueAtTime(0.01, time + 0.05);
        
        noise.start(time);
        noise.stop(time + 0.2);
        osc.start(time);
        osc.stop(time + 0.05);
    }
    
    function playHiHat(time, open = false) {
        const ctx = initAudioContext();
        
        const noiseBuffer = ctx.createBuffer(1, ctx.sampleRate * (open ? 0.3 : 0.05), ctx.sampleRate);
        const noiseData = noiseBuffer.getChannelData(0);
        for (let i = 0; i < noiseBuffer.length; i++) {
            noiseData[i] = Math.random() * 2 - 1;
        }
        
        const noise = ctx.createBufferSource();
        noise.buffer = noiseBuffer;
        
        const filter = ctx.createBiquadFilter();
        filter.type = 'highpass';
        filter.frequency.value = 7000;
        
        const gain = ctx.createGain();
        const duration = open ? 0.3 : 0.05;
        gain.gain.setValueAtTime(0.25 * volume, time);
        gain.gain.exponentialRampToValueAtTime(0.01, time + duration);
        
        noise.connect(filter);
        filter.connect(gain);
        gain.connect(ctx.destination);
        
        noise.start(time);
        noise.stop(time + duration);
    }
    
    function playRideCymbal(time) {
        const ctx = initAudioContext();
        
        const osc = ctx.createOscillator();
        const osc2 = ctx.createOscillator();
        const gain = ctx.createGain();
        
        osc.type = 'triangle';
        osc2.type = 'triangle';
        osc.frequency.value = 350;
        osc2.frequency.value = 620;
        
        osc.connect(gain);
        osc2.connect(gain);
        gain.connect(ctx.destination);
        
        gain.gain.setValueAtTime(0.15 * volume, time);
        gain.gain.exponentialRampToValueAtTime(0.01, time + 0.5);
        
        osc.start(time);
        osc2.start(time);
        osc.stop(time + 0.5);
        osc2.stop(time + 0.5);
    }
    
    // Drum patterns (16th note grid for one bar, 16 steps)
    // K = Kick, S = Snare, H = HiHat, O = Open HiHat, R = Ride, - = rest
    const drumPatterns = {
        basic_rock: {
            name: 'Basic Rock',
            kick:   [1,0,0,0, 1,0,0,0, 1,0,0,0, 1,0,0,0],
            snare:  [0,0,0,0, 1,0,0,0, 0,0,0,0, 1,0,0,0],
            hihat:  [1,0,1,0, 1,0,1,0, 1,0,1,0, 1,0,1,0],
            open:   [0,0,0,0, 0,0,0,0, 0,0,0,0, 0,0,0,0]
        },
        funk: {
            name: 'Funk',
            kick:   [1,0,0,1, 0,0,1,0, 0,1,0,0, 1,0,0,0],
            snare:  [0,0,0,0, 1,0,0,1, 0,0,0,0, 1,0,0,0],
            hihat:  [1,1,1,1, 1,1,1,1, 1,1,1,1, 1,1,1,1],
            open:   [0,0,0,0, 0,0,0,0, 0,0,0,0, 0,0,0,1]
        },
        blues_shuffle: {
            name: 'Blues Shuffle',
            kick:   [1,0,0,0, 0,0,1,0, 1,0,0,0, 0,0,1,0],
            snare:  [0,0,0,0, 1,0,0,0, 0,0,0,0, 1,0,0,0],
            hihat:  [1,0,1,0, 1,0,1,0, 1,0,1,0, 1,0,1,0],
            open:   [0,0,0,0, 0,0,0,0, 0,0,0,0, 0,0,0,0],
            swing: true
        },
        jazz_swing: {
            name: 'Jazz Swing',
            kick:   [1,0,0,0, 0,0,1,0, 0,0,1,0, 0,0,0,0],
            snare:  [0,0,0,0, 0,0,0,0, 0,0,0,0, 0,1,0,0],
            hihat:  [0,0,0,0, 1,0,0,0, 0,0,0,0, 1,0,0,0],
            ride:   [1,0,1,0, 1,0,1,0, 1,0,1,0, 1,0,1,0],
            swing: true
        },
        latin: {
            name: 'Latin',
            kick:   [1,0,0,1, 0,0,1,0, 0,0,1,0, 0,1,0,0],
            snare:  [0,0,0,0, 0,0,0,0, 0,0,0,0, 0,0,0,0],
            hihat:  [1,0,1,0, 1,0,1,0, 1,0,1,0, 1,0,1,0],
            open:   [0,0,0,0, 0,0,0,0, 0,0,0,0, 0,0,0,0]
        },
        reggae: {
            name: 'Reggae',
            kick:   [0,0,0,0, 1,0,0,0, 0,0,0,0, 1,0,0,0],
            snare:  [0,0,0,0, 0,0,0,0, 1,0,0,0, 0,0,0,0],
            hihat:  [0,0,1,0, 0,0,1,0, 0,0,1,0, 0,0,1,0],
            open:   [1,0,0,0, 0,0,0,0, 0,0,0,0, 0,0,0,0]
        },
        disco: {
            name: 'Disco',
            kick:   [1,0,0,0, 1,0,0,0, 1,0,0,0, 1,0,0,0],
            snare:  [0,0,0,0, 1,0,0,0, 0,0,0,0, 1,0,0,0],
            hihat:  [1,1,1,1, 1,1,1,1, 1,1,1,1, 1,1,1,1],
            open:   [0,0,0,1, 0,0,0,1, 0,0,0,1, 0,0,0,1]
        },
        metal: {
            name: 'Metal',
            kick:   [1,0,1,0, 1,0,1,0, 1,0,1,0, 1,0,1,0],
            snare:  [0,0,0,0, 1,0,0,0, 0,0,0,0, 1,0,0,0],
            hihat:  [1,1,1,1, 1,1,1,1, 1,1,1,1, 1,1,1,1],
            open:   [0,0,0,0, 0,0,0,0, 0,0,0,0, 0,0,0,0]
        }
    };
    
    function getSelectedPattern() {
        const patternId = document.getElementById('drumPatternSelect').value;
        return drumPatterns[patternId] || drumPatterns.basic_rock;
    }
    
    function playDrumBeat() {
        const ctx = initAudioContext();
        const bpm = parseInt(document.getElementById('tempoSlider').value);
        const pattern = getSelectedPattern();
        
        // Time for one 16th note
        const sixteenthTime = (60 / bpm) / 4;
        const swingAmount = pattern.swing ? 0.33 : 0;
        
        const step = currentBeat % 16;
        const time = ctx.currentTime;
        
        // Apply swing to off-beat 16th notes
        let offset = 0;
        if (swingAmount > 0 && step % 2 === 1) {
            offset = sixteenthTime * swingAmount;
        }
        
        // Play drum sounds based on pattern
        if (pattern.kick[step]) playKick(time + offset);
        if (pattern.snare[step]) playSnare(time + offset);
        if (pattern.open && pattern.open[step]) {
            playHiHat(time + offset, true);
        } else if (pattern.hihat[step]) {
            playHiHat(time + offset, false);
        }
        if (pattern.ride && pattern.ride[step]) playRideCymbal(time + offset);
        
        currentBeat++;
    }
    
    function toggleTiming() {
        const btn = document.getElementById('metronomeBtn');
        
        if (timingRunning) {
            // Stop
            if (timingInterval) {
                clearInterval(timingInterval);
                timingInterval = null;
            }
            timingRunning = false;
            currentBeat = 0;
            btn.innerHTML = '<i class="bi bi-play-fill"></i> Start';
        } else {
            // Start
            initAudioContext();
            const bpm = parseInt(document.getElementById('tempoSlider').value);
            
            timingRunning = true;
            btn.innerHTML = '<i class="bi bi-stop-fill"></i> Stop';
            
            if (isDrumMode()) {
                // 16th note interval for drum patterns
                const sixteenthTime = (60000 / bpm) / 4;
                currentBeat = 0;
                playDrumBeat();
                timingInterval = setInterval(playDrumBeat, sixteenthTime);
            } else {
                // Regular metronome (quarter notes)
                const intervalMs = 60000 / bpm;
                let beatCount = 0;
                const playMetronomeClick = () => {
                    playClick(beatCount % 4 === 0);
                    beatCount++;
                };
                playMetronomeClick();
                timingInterval = setInterval(playMetronomeClick, intervalMs);
            }
        }
    }
    
    function adjustTempo(delta) {
        const slider = document.getElementById('tempoSlider');
        let newValue = parseInt(slider.value) + delta;
        newValue = Math.max(40, Math.min(200, newValue));
        slider.value = newValue;
        document.getElementById('bpmDisplay').textContent = newValue;
        
        // Restart if running
        if (timingRunning) {
            toggleTiming();
            toggleTiming();
        }
    }
    
    // Mode toggle listeners
    document.getElementById('modeMetronome').addEventListener('change', function() {
        document.getElementById('drumPatternSection').style.display = 'none';
        if (timingRunning) {
            toggleTiming();
            toggleTiming();
        }
    });
    
    document.getElementById('modeDrums').addEventListener('change', function() {
        document.getElementById('drumPatternSection').style.display = 'block';
        if (timingRunning) {
            toggleTiming();
            toggleTiming();
        }
    });
    
    document.getElementById('tempoSlider').addEventListener('input', function() {
        document.getElementById('bpmDisplay').textContent = this.value;
    });
    
    document.getElementById('tempoSlider').addEventListener('change', function() {
        if (timingRunning) {
            toggleTiming();
            toggleTiming();
        }
    });
    
    document.getElementById('drumPatternSelect').addEventListener('change', function() {
        currentBeat = 0;
        if (timingRunning && isDrumMode()) {
            toggleTiming();
            toggleTiming();
        }
    });
    
    document.getElementById('volumeSlider').addEventListener('input', function() {
        volume = this.value / 100;
    });
    
    // Mark exercise as complete
    function markExerciseComplete() {
        const btn = document.getElementById('completeExerciseBtn');
        const status = document.getElementById('completeStatus');
        
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Saving...';
        
        fetch('/exercises/complete', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                category: '{{ exercise.category }}',
                duration: {{ exercise.estimated_duration }}
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                btn.innerHTML = '<i class="bi bi-check-circle"></i> Completed!';
                btn.classList.remove('btn-success');
                btn.classList.add('btn-secondary');
                status.innerHTML = `
                    <div class="alert alert-success mb-0">
                        <i class="bi bi-check-circle"></i> 
                        Progress updated! Skill level: ${(data.skill_level * 100).toFixed(1)}% 
                        (${data.exercises_completed} exercises completed)
                    </div>
                `;
            } else {
                btn.disabled = false;
                btn.innerHTML = '<i class="bi bi-check-circle"></i> Mark as Complete';
                status.innerHTML = '<div class="alert alert-danger mb-0">Error updating progress</div>';
            }
        })
        .catch(error => {
            btn.disabled = false;
            btn.innerHTML = '<i class="bi bi-check-circle"></i> Mark as Complete';
            status.innerHTML = '<div class="alert alert-danger mb-0">Error updating progress</div>';
        });
    }
</script>
{% endblock %}
